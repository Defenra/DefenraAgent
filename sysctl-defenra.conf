# Defenra Agent - Kernel Tuning for DDoS Protection
# Apply with: sudo sysctl -p /path/to/sysctl-defenra.conf
# Or copy to: /etc/sysctl.d/99-defenra.conf

# ============================================================================
# SYN Flood Protection
# ============================================================================

# Enable SYN cookies - CRITICAL for SYN flood protection
# When SYN queue overflows, kernel doesn't store state but encrypts it in response
# This is the main defense against SYN Flood before Go accepts connection
net.ipv4.tcp_syncookies = 1

# Increase SYN backlog queue (default is often 128 or 1024)
# This is the queue of half-open connections waiting for final ACK
net.ipv4.tcp_max_syn_backlog = 40960

# Increase accept queue (connections waiting for Accept() from Go application)
# If Go pauses for a second, new clients shouldn't get refused
net.core.somaxconn = 65535

# Reduce SYN-ACK retries (default is 5, we set to 2)
# If bot sends SYN, we respond, but it stays silent - forget about it faster
net.ipv4.tcp_synack_retries = 2

# Reduce SYN retries for outgoing connections
net.ipv4.tcp_syn_retries = 2

# ============================================================================
# Connection Tracking (Conntrack) Tuning
# ============================================================================

# Increase connection tracking table size (default is often 65536)
# Each connection consumes memory, but we need to track millions under attack
net.netfilter.nf_conntrack_max = 2000000

# Reduce timeout for established connections (default is 432000 = 5 days)
# We don't need to remember connections for days
net.netfilter.nf_conntrack_tcp_timeout_established = 600

# Reduce timeout for TIME_WAIT state (default is 120 seconds)
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30

# Reduce timeout for CLOSE_WAIT state
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 30

# ============================================================================
# TCP Performance & Security
# ============================================================================

# Enable TCP Fast Open (reduces latency for repeat connections)
net.ipv4.tcp_fastopen = 3

# Reuse TIME_WAIT sockets for new connections (safe with modern timestamps)
net.ipv4.tcp_tw_reuse = 1

# Disable TCP timestamps (slight performance gain, but reduces security)
# Uncomment if you need maximum performance and don't care about PAWS
# net.ipv4.tcp_timestamps = 0

# Increase TCP buffer sizes for high-throughput scenarios
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# Enable TCP window scaling
net.ipv4.tcp_window_scaling = 1

# ============================================================================
# Network Stack Tuning
# ============================================================================

# Increase network device backlog (default is 1000)
# This is the queue between NIC and kernel network stack
net.core.netdev_max_backlog = 50000

# Increase maximum number of open files (file descriptors)
# Each connection = 1 FD, we need many for high concurrency
fs.file-max = 2097152

# ============================================================================
# ICMP & Other Protocols
# ============================================================================

# Ignore ICMP redirects (security)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

# Ignore source-routed packets (security)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Enable reverse path filtering (anti-spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log martian packets (packets with impossible source addresses)
net.ipv4.conf.all.log_martians = 1

# ============================================================================
# IPv6 (if used)
# ============================================================================

# Disable IPv6 if not used (reduces attack surface)
# Uncomment if you don't use IPv6
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1

# If using IPv6, apply same protections
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# ============================================================================
# Memory & Swap
# ============================================================================

# Reduce swappiness (prefer RAM over swap for better performance)
vm.swappiness = 10

# Increase dirty page writeback interval (better for SSDs)
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# ============================================================================
# Notes
# ============================================================================

# After applying these settings:
# 1. Verify with: sysctl -a | grep -E "tcp_syncookies|tcp_max_syn_backlog|somaxconn"
# 2. Monitor with: netstat -s | grep -E "SYN|cookie"
# 3. Check conntrack: cat /proc/sys/net/netfilter/nf_conntrack_count
# 4. Reboot to ensure settings persist (or add to /etc/sysctl.d/)

# WARNING: These settings are optimized for DDoS protection and high traffic.
# They may not be suitable for all environments. Test before production deployment.
